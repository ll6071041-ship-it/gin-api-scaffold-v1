package main

import (
	"context"
	"fmt"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"github.com/spf13/viper"
	"go.uber.org/zap" // ğŸ‘ˆ å¿…é¡»å¼•å…¥å®˜æ–¹åŒ…ï¼Œæ‰èƒ½ä½¿ç”¨å…¨å±€çš„ zap.L()

	"gin-api-scaffold-v1/dao"
	"gin-api-scaffold-v1/logger"
	"gin-api-scaffold-v1/pkg/snowflake"
	"gin-api-scaffold-v1/routers"
	"gin-api-scaffold-v1/settings"
)

// Go Web å¼€å‘é€šç”¨çš„è„šæ‰‹æ¶å…¥å£
func main() {
	// =========================================================================
	// 1. åŠ è½½é…ç½® (Viper)
	// =========================================================================
	// å¦‚æœé…ç½®æ–‡ä»¶éƒ½è¯»ä¸åˆ°ï¼Œç³»ç»Ÿæ— æ³•è¿è¡Œï¼Œç›´æ¥ Panic æŒ‚æ‰æ˜¯æœ€å¥½çš„é€‰æ‹©
	if err := settings.InitConfig(); err != nil {
		panic(fmt.Sprintf("åŠ è½½é…ç½®å¤±è´¥: %v", err))
	}

	// =========================================================================
	// 2. åˆå§‹åŒ–æ—¥å¿— (Zap)
	// =========================================================================
	// âš ï¸ æ³¨æ„ï¼šè¿™ä¸€æ­¥å¿…é¡»å°½æ—©æ‰§è¡Œï¼
	// åªæœ‰æ‰§è¡Œäº† logger.InitLogger()ï¼Œå…¨å±€çš„ zap.L() æ‰ä¼šè¢«æ›¿æ¢æˆæˆ‘ä»¬å°†é…ç½®å¥½çš„ Loggerã€‚
	// å¦åˆ™åé¢è°ƒç”¨ zap.L().Info() éƒ½æ˜¯ç©ºçš„ï¼Œä»€ä¹ˆéƒ½æ‰“ä¸å‡ºæ¥ã€‚
	logger.InitLogger()

	// defer Sync(): è¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚
	// å®ƒçš„ä½œç”¨æ˜¯ï¼šåœ¨ main å‡½æ•°ç»“æŸå‰ï¼ŒæŠŠå†…å­˜é‡Œè¿˜æ²¡æ¥å¾—åŠå†™å…¥ç¡¬ç›˜çš„æ—¥å¿—ï¼Œå¼ºåˆ¶åˆ·å…¥ç¡¬ç›˜ã€‚
	// é˜²æ­¢ç¨‹åºå´©æºƒæˆ–é€€å‡ºæ—¶ä¸¢å¤±æœ€åå‡ æ¡æ—¥å¿—ã€‚
	defer zap.L().Sync()

	// æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œè¯æ˜æ—¥å¿—ç³»ç»Ÿå¯åŠ¨æˆåŠŸ
	zap.L().Debug("logger init success...")

	// =========================================================================
	// 3. åˆå§‹åŒ–é›ªèŠ±ç®—æ³• (Snowflake)
	// =========================================================================
	// å‚æ•°1 "2026-01-01": æˆ‘ä»¬çš„é¡¹ç›®èµ·å§‹æ—¶é—´ã€‚
	// å‚æ•°2 "1": å½“å‰æœºå™¨ ID (MachineID)ã€‚
	// âš ï¸ åˆ†å¸ƒå¼éƒ¨ç½²è­¦å‘Šï¼šå¦‚æœä½ ä»¥åéƒ¨ç½²å¤šå°æœåŠ¡å™¨ï¼Œæ¯å°çš„è¿™ä¸ªæ•°å­—å¿…é¡»ä¸ä¸€æ ·(1, 2, 3...)
	// å»ºè®®ä»é…ç½®æ–‡ä»¶è¯»å–: viper.GetInt64("app.machine_id")
	if err := snowflake.Init("2026-01-01", 1); err != nil {
		fmt.Printf("init snowflake failed, err:%v\n", err)
		return
	}

	// =========================================================================
	// 4. åˆå§‹åŒ– MySQL (GORM)
	// =========================================================================
	// å»ºç«‹æ•°æ®åº“è¿æ¥æ± ã€‚å¦‚æœè¿ä¸ä¸Šæ•°æ®åº“ï¼Œç¨‹åºä¹Ÿæ— æ³•å·¥ä½œï¼Œç›´æ¥ Panicã€‚
	if err := dao.InitMySQL(); err != nil {
		panic(err)
	}
	// è¿™é‡Œçš„ deferClose ä¸å»ºè®®ç”¨äº†ï¼ŒGORM ç»´æŠ¤è¿æ¥æ± ï¼Œé€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨å…³é—­

	// =========================================================================
	// 5. åˆå§‹åŒ– Redis
	// =========================================================================
	// å»ºç«‹ Redis è¿æ¥æ± ã€‚
	if err := dao.InitRedis(); err != nil {
		panic(err)
	}

	// =========================================================================
	// 6. æ³¨å†Œè·¯ç”± (Gin)
	// =========================================================================
	// è¿™é‡Œä¼šåŠ è½½æˆ‘ä»¬åœ¨ routers åŒ…é‡Œå®šä¹‰çš„æ‰€æœ‰ URL è§„åˆ™å’Œä¸­é—´ä»¶
	r := routers.SetupRouter()

	// =========================================================================
	// 7. å¯åŠ¨æœåŠ¡ (HTTP Server)
	// =========================================================================
	port := viper.GetString("app.port")

	// æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª http.Serverï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ r.Run()
	// ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º r.Run() å¾ˆéš¾æ§åˆ¶â€œä¼˜é›…å…³æœºâ€ï¼Œæ‰‹åŠ¨åˆ›å»º Server å¯¹è±¡å¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶ Shutdown æ–¹æ³•ã€‚
	srv := &http.Server{
		Addr:    ":" + port,
		Handler: r,
	}

	// ğŸš€ å¼€å¯ä¸€ä¸ªåç¨‹ (Goroutine) å¯åŠ¨æœåŠ¡
	// ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º srv.ListenAndServe() æ˜¯ä¸€ä¸ªâ€œæ­»å¾ªç¯â€ï¼Œå®ƒä¼šå¡ä½å½“å‰çº¿ç¨‹ä¸€ç›´ç­‰å¾…è¯·æ±‚ã€‚
	// å¦‚æœä¸æ”¾åœ¨åç¨‹é‡Œï¼Œåé¢çš„â€œä¼˜é›…å…³æœºâ€ä»£ç æ°¸è¿œæ‰§è¡Œä¸åˆ°ã€‚
	go func() {
		fmt.Printf("æœåŠ¡æ­£åœ¨å¯åŠ¨ï¼Œç«¯å£: %s\n", port)
		zap.L().Info("Server is starting...", zap.String("port", port))

		// å¯åŠ¨æœåŠ¡ã€‚å¦‚æœè¿”å›é”™è¯¯ï¼Œä¸”é”™è¯¯ä¸æ˜¯â€œæœåŠ¡å™¨å·²å…³é—­â€ï¼Œè¯´æ˜å¯åŠ¨å¤±è´¥ï¼ˆæ¯”å¦‚ç«¯å£è¢«å ç”¨ï¼‰
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			// Fatal ä¼šæ‰“å°é”™è¯¯æ—¥å¿—å¹¶ç›´æ¥é€€å‡ºç¨‹åº (os.Exit)
			zap.L().Fatal("listen: ", zap.Error(err))
		}
	}()

	// =========================================================================
	// 8. ä¼˜é›…å…³æœº (Graceful Shutdown) - é¢è¯•é‡ç‚¹ï¼
	// =========================================================================

	// åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œä¸“é—¨ç”¨æ¥æ¥æ”¶æ“ä½œç³»ç»Ÿçš„ä¿¡å·
	quit := make(chan os.Signal, 1)

	// signal.Notify å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼š
	// å¦‚æœæ”¶åˆ°äº† SIGINT (Ctrl+C) æˆ–è€… SIGTERM (Docker åœæ­¢å®¹å™¨/K8s é”€æ¯ Pod)ï¼Œ
	// è¯·æŠŠä¿¡å·å‘ç»™ quit é€šé“ï¼Œä¸è¦ç›´æ¥æŠŠæˆ‘çš„ç¨‹åºæ€æ‰ï¼
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)

	// ğŸ›‘ ç¨‹åºä¼šå¡åœ¨è¿™é‡Œâ€œæ­»ç­‰â€ï¼
	// ç›´åˆ° quit é€šé“é‡Œæ”¶åˆ°äº†ä¿¡å·ï¼Œæ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
	<-quit

	zap.L().Info("Shutdown Server ...")

	// åˆ›å»ºä¸€ä¸ª 5 ç§’çš„è¶…æ—¶ä¸Šä¸‹æ–‡
	// æ„æ€æ˜¯ï¼šæˆ‘ç»™æœåŠ¡å™¨ 5 ç§’é’Ÿçš„æ—¶é—´å»å¤„ç†æ‰‹é‡Œè¿˜æ²¡å¤„ç†å®Œçš„è¯·æ±‚ã€‚
	// å¦‚æœ 5 ç§’åˆ°äº†è¿˜æ²¡å¤„ç†å®Œï¼Œå°±å¼ºåˆ¶å…³é—­ï¼Œä¸å†ç­‰äº†ã€‚
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	// srv.Shutdown ä¼šåšä¸¤ä»¶äº‹ï¼š
	// 1. é©¬ä¸Šåœæ­¢æ¥æ”¶æ–°çš„è¯·æ±‚ã€‚
	// 2. ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å¤„ç†å®Œï¼ˆæˆ–è€…ç›´åˆ° ctx è¶…æ—¶ï¼‰ã€‚
	if err := srv.Shutdown(ctx); err != nil {
		zap.L().Fatal("Server Shutdown:", zap.Error(err))
	}

	zap.L().Info("Server exiting")
}

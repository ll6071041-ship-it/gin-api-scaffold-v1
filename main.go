package main

import (
	"context"
	"fmt"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"github.com/spf13/viper"
	"go.uber.org/zap"

	"gin-api-scaffold-v1/dao"
	// âš ï¸ æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»å¼•å…¥ docs åŒ…ï¼Œå¦åˆ™ Swagger æ— æ³•åŠ è½½æ–‡æ¡£æ•°æ®
	_ "gin-api-scaffold-v1/docs"
	"gin-api-scaffold-v1/logger"
	"gin-api-scaffold-v1/pkg/snowflake"

	// ğŸ‘‡ å¼•å…¥æˆ‘ä»¬åˆšåˆšå†™çš„ validator åŒ…ï¼Œèµ·ä¸ªåˆ«å myValidator é˜²æ­¢å’Œå®˜æ–¹åŒ…é‡å
	myValidator "gin-api-scaffold-v1/pkg/validator"
	"gin-api-scaffold-v1/routers"
	"gin-api-scaffold-v1/settings"
)

// @title           Bluebellé¡¹ç›®æ¥å£æ–‡æ¡£
// @version         1.0
// @description     è¿™æ˜¯ä¸€ä¸ªåŸºäºGinæ¡†æ¶çš„ç¤¾åŒºåç«¯é¡¹ç›®(ä»¿Reddit)
// @termsOfService  http://swagger.io/terms/

// @contact.name    KKK
// @contact.url     http://www.liwenzhou.com
// @contact.email   support@swagger.io

// @license.name    Apache 2.0
// @license.url     http://www.apache.org/licenses/LICENSE-2.0.html

// @host            localhost:8080
// @BasePath        /api/v1

// @securityDefinitions.apikey ApiKeyAuth
// @in header
// @name Authorization

// main å‡½æ•°æ˜¯ Go Web é¡¹ç›®çš„å”¯ä¸€å…¥å£
func main() {
	// =========================================================================
	// 1. åŠ è½½é…ç½® (Viper)
	// =========================================================================
	// è¿™ä¸€æ­¥è¯»å– config.yaml æ–‡ä»¶ã€‚å¦‚æœè¿é…ç½®æ–‡ä»¶éƒ½è¯»ä¸åˆ°ï¼ˆæ¯”å¦‚æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯ï¼‰ï¼Œ
	// åç»­ä»£ç æ— æ³•è¿è¡Œï¼Œæ‰€ä»¥ç›´æ¥ Panic ç»ˆæ­¢ç¨‹åºæ˜¯åˆç†çš„ã€‚
	if err := settings.InitConfig(); err != nil {
		panic(fmt.Sprintf("åŠ è½½é…ç½®å¤±è´¥: %v", err))
	}

	// =========================================================================
	// 2. åˆå§‹åŒ–æ—¥å¿— (Zap)
	// =========================================================================
	// âš ï¸ è¿™ä¸€æ­¥å¿…é¡»å°½æ—©æ‰§è¡Œï¼
	// åªæœ‰æ‰§è¡Œäº† InitLoggerï¼Œå…¨å±€çš„ zap.L() æ‰ä¼šè¢«é…ç½®å¥½ã€‚
	// å¦‚æœä¸åˆå§‹åŒ–ï¼Œåç»­è°ƒç”¨ zap.L().Info() å°†ä¸ä¼šè¾“å‡ºä»»ä½•å†…å®¹ã€‚
	logger.InitLogger()

	// defer Sync(): è¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚
	// å®ƒçš„ä½œç”¨æ˜¯ï¼šåœ¨ main å‡½æ•°ç»“æŸå‰ï¼ŒæŠŠå†…å­˜é‡Œç¼“å­˜çš„æ—¥å¿—å¼ºåˆ¶åˆ·å…¥ç¡¬ç›˜ã€‚
	// é˜²æ­¢ç¨‹åºå´©æºƒæˆ–é€€å‡ºæ—¶ï¼Œæœ€åå‡ æ¡å…³é”®æ—¥å¿—ä¸¢å¤±ã€‚
	defer zap.L().Sync()

	// æ‰“å°ä¸€æ¡ Debug æ—¥å¿—ï¼Œç¡®è®¤æ—¥å¿—ç³»ç»Ÿå¯åŠ¨æˆåŠŸ
	zap.L().Debug("logger init success...")

	// =========================================================================
	// 3. åˆå§‹åŒ–é›ªèŠ±ç®—æ³• (Snowflake)
	// =========================================================================
	// ç”¨äºç”Ÿæˆå…¨å±€å”¯ä¸€çš„ ID (æ¯”å¦‚è®¢å•å·ã€ç”¨æˆ·ID)ã€‚
	// å‚æ•°1 "2026-01-01": é¡¹ç›®çš„èµ·å§‹æ—¶é—´ã€‚
	// å‚æ•°2 1: å½“å‰æœºå™¨ ID (MachineID)ã€‚
	// âš ï¸ æ³¨æ„ï¼šå¦‚æœæ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆå¤šå°æœåŠ¡å™¨ï¼‰ï¼Œæ¯å°æœºå™¨çš„ MachineID å¿…é¡»ä¸åŒï¼
	if err := snowflake.Init("2026-01-01", 1); err != nil {
		fmt.Printf("init snowflake failed, err:%v\n", err)
		return
	}

	// =========================================================================
	// ğŸ”¥ 4. æ–°å¢ï¼šåˆå§‹åŒ– Validator ç¿»è¯‘å™¨ (æ±‰åŒ–æ ¡éªŒ)
	// =========================================================================
	// è¿™ä¸€æ­¥åŠ è½½ä¸­æ–‡è¯­è¨€åŒ…ï¼Œå¹¶æ³¨å†Œ json tag è‡ªå®šä¹‰æ–¹æ³•ã€‚
	// å¦‚æœå¤±è´¥ï¼Œæ„å‘³ç€å‚æ•°æ ¡éªŒè¿”å›çš„é”™è¯¯å…¨æ˜¯è‹±æ–‡ä¸”æ ¼å¼æ··ä¹±ï¼Œä¸¥é‡å½±å“å‰ç«¯ä½“éªŒï¼Œæ‰€ä»¥å»ºè®®å¤„ç†é”™è¯¯ã€‚
	if err := myValidator.InitTrans("zh"); err != nil {
		fmt.Printf("init validator failed, err:%v\n", err)
		return
	}

	// =========================================================================
	// 5. åˆå§‹åŒ– MySQL (GORM)
	// =========================================================================
	// å»ºç«‹æ•°æ®åº“è¿æ¥æ± ã€‚å¦‚æœè¿ä¸ä¸Šæ•°æ®åº“ï¼Œåç«¯æœåŠ¡æ²¡æœ‰æ„ä¹‰ï¼Œç›´æ¥ Panicã€‚
	if err := dao.InitMySQL(); err != nil {
		panic(err)
	}
	// GORM è‡ªèº«ç»´æŠ¤è¿æ¥æ± ï¼Œé€šå¸¸ä¸éœ€è¦åƒ sql.DB é‚£æ ·æ‰‹åŠ¨ defer Close

	// =========================================================================
	// 6. åˆå§‹åŒ– Redis
	// =========================================================================
	// å»ºç«‹ Redis è¿æ¥æ± ï¼Œç”¨äºç¼“å­˜æˆ– session ç®¡ç†ã€‚
	if err := dao.InitRedis(); err != nil {
		panic(err)
	}

	// =========================================================================
	// 7. æ³¨å†Œè·¯ç”± (Gin)
	// =========================================================================
	// åŠ è½½ routers åŒ…é‡Œå®šä¹‰çš„æ‰€æœ‰ URL è§„åˆ™ã€ä¸­é—´ä»¶ï¼ˆæ—¥å¿—ã€è·¨åŸŸã€Recoveryï¼‰ã€‚
	r := routers.SetupRouter()

	// =========================================================================
	// 8. å¯åŠ¨æœåŠ¡ (HTTP Server)
	// =========================================================================
	port := viper.GetString("app.port") // ä»é…ç½®æ–‡ä»¶è¯»å–ç«¯å£

	// æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª http.Serverï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ r.Run()
	// åŸå› ï¼šr.Run() å†…éƒ¨ä¹Ÿæ˜¯åˆ›å»º serverï¼Œä½†å®ƒä¸æ–¹ä¾¿æˆ‘ä»¬åœ¨å¤–éƒ¨è°ƒç”¨ Shutdown åšä¼˜é›…å…³æœºã€‚
	srv := &http.Server{
		Addr:    ":" + port,
		Handler: r,
	}

	// ğŸš€ å¼€å¯ä¸€ä¸ªåç¨‹ (Goroutine) å¯åŠ¨æœåŠ¡
	// ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º srv.ListenAndServe() æ˜¯ä¸€ä¸ªâ€œæ­»å¾ªç¯â€ï¼Œå®ƒä¼šå¡ä½å½“å‰çº¿ç¨‹ä¸€ç›´ç­‰å¾…è¯·æ±‚ã€‚
	// å¦‚æœä¸æ”¾åœ¨åç¨‹é‡Œï¼Œä¸»çº¿ç¨‹å¡åœ¨è¿™é‡Œï¼Œåé¢çš„â€œä¼˜é›…å…³æœºâ€ä»£ç æ°¸è¿œæ‰§è¡Œä¸åˆ°ã€‚
	go func() {
		fmt.Printf("æœåŠ¡æ­£åœ¨å¯åŠ¨ï¼Œç«¯å£: %s\n", port)
		zap.L().Info("Server is starting...", zap.String("port", port))

		// å¯åŠ¨æœåŠ¡ã€‚
		// å¦‚æœè¿”å›é”™è¯¯ï¼Œä¸”é”™è¯¯ä¸æ˜¯â€œæœåŠ¡å™¨å·²å…³é—­(http.ErrServerClosed)â€ï¼Œè¯´æ˜å¯åŠ¨å¤±è´¥ï¼ˆæ¯”å¦‚ç«¯å£è¢«å ç”¨ï¼‰ã€‚
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			// Fatal ä¼šæ‰“å°é”™è¯¯æ—¥å¿—å¹¶ç›´æ¥é€€å‡ºç¨‹åº (os.Exit)
			zap.L().Fatal("listen: ", zap.Error(err))
		}
	}()

	// =========================================================================
	// 9. ä¼˜é›…å…³æœº (Graceful Shutdown)
	// =========================================================================

	// åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œä¸“é—¨ç”¨æ¥æ¥æ”¶æ“ä½œç³»ç»Ÿçš„ä¿¡å·
	quit := make(chan os.Signal, 1)

	// signal.Notify å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼š
	// å¦‚æœæ”¶åˆ°äº† SIGINT (Ctrl+C) æˆ–è€… SIGTERM (Docker åœæ­¢å®¹å™¨/K8s é”€æ¯ Pod)ï¼Œ
	// è¯·æŠŠä¿¡å·å‘ç»™ quit é€šé“ï¼Œä¸è¦ç›´æ¥æŠŠæˆ‘çš„ç¨‹åºæ€æ‰ï¼è®©æˆ‘æœ‰æ—¶é—´å¤„ç†åäº‹ã€‚
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)

	// ğŸ›‘ ç¨‹åºä¼šå¡åœ¨è¿™é‡Œâ€œæ­»ç­‰â€ï¼
	// ç›´åˆ° quit é€šé“é‡Œæ”¶åˆ°äº†ä¿¡å·ï¼Œä¸»çº¿ç¨‹æ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
	<-quit

	zap.L().Info("Shutdown Server ...")

	// åˆ›å»ºä¸€ä¸ª 5 ç§’çš„è¶…æ—¶ä¸Šä¸‹æ–‡
	// æ„æ€æ˜¯ï¼šæˆ‘ç»™æœåŠ¡å™¨ 5 ç§’é’Ÿçš„æ—¶é—´å»å¤„ç†æ‰‹é‡Œè¿˜æ²¡å¤„ç†å®Œçš„è¯·æ±‚ã€‚
	// å¦‚æœ 5 ç§’åˆ°äº†è¿˜æ²¡å¤„ç†å®Œï¼Œå°±å¼ºåˆ¶å…³é—­ï¼Œä¸å†ç­‰äº†ã€‚
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	// srv.Shutdown ä¼šåšä¸¤ä»¶äº‹ï¼š
	// 1. é©¬ä¸Šåœæ­¢æ¥æ”¶æ–°çš„è¯·æ±‚ã€‚
	// 2. ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å¤„ç†å®Œï¼ˆæˆ–è€…ç›´åˆ° ctx è¶…æ—¶ï¼‰ã€‚
	if err := srv.Shutdown(ctx); err != nil {
		zap.L().Fatal("Server Shutdown:", zap.Error(err))
	}

	zap.L().Info("Server exiting")
}

package routers

import (
	"net/http"

	"github.com/gin-gonic/gin"

	"gin-api-scaffold-v1/controller"
	"gin-api-scaffold-v1/middleware"
)

// SetupRouter é…ç½®è·¯ç”±å…¥å£
// è´Ÿè´£æŠŠæ‰€æœ‰çš„ URL è·¯å¾„å’Œ Controller é‡Œçš„å‡½æ•°å¯¹åº”èµ·æ¥
func SetupRouter() *gin.Engine {
	// 1. åˆ›å»º Gin å®ä¾‹ (ç™½çº¸æ¨¡å¼)
	// ä½¿ç”¨ gin.New() è€Œä¸æ˜¯ gin.Default()ï¼Œä»¥ä¾¿æˆ‘ä»¬è‡ªå·±å®šåˆ¶ä¸­é—´ä»¶
	r := gin.New()

	// =======================================================
	// 2. æ³¨å†Œå…¨å±€ä¸­é—´ä»¶ (Middleware)
	// =======================================================
	// è®°å½•è¯·æ±‚æ—¥å¿—ï¼šæŠŠ Gin çš„è¯·æ±‚è¯¦æƒ…è®°å½•åˆ°æˆ‘ä»¬çš„ Zap æ—¥å¿—æ–‡ä»¶ä¸­
	r.Use(middleware.GinLogger())
	// å´©æºƒæ¢å¤ï¼šé˜²æ­¢ç¨‹åº Panic å¯¼è‡´æ•´ä¸ªæœåŠ¡æŒ‚æ‰
	r.Use(middleware.GinRecovery(true))
	// è·¨åŸŸå¤„ç† (CORS)ï¼šå…è®¸å‰ç«¯è·¨åŸŸè®¿é—®
	r.Use(middleware.Cors())

	// =======================================================
	// 3. æ³¨å†ŒåŸºç¡€è·¯ç”± (Infrastructure)
	// =======================================================
	// å¥åº·æ£€æŸ¥æ¥å£ï¼Œè®¿é—®ï¼šGET /ping
	r.GET("/ping", controller.Ping)

	// =======================================================
	// 4. ä¸šåŠ¡è·¯ç”±åˆ†ç»„ (Business Logic)
	// =======================================================
	// åˆ›å»ºä¸€ä¸ªè·¯ç”±ç»„ï¼Œå‰ç¼€æ˜¯ /api/v1
	// æ­¤æ—¶ api å˜é‡è¿˜æ²¡æœ‰æŒ‚è½½ JWT ä¸­é—´ä»¶
	api := r.Group("/api/v1")
	{
		// ---------------------------------------------------
		// ğŸš« å…¬å¼€è·¯ç”± (æ— éœ€ Token å³å¯è®¿é—®)
		// ---------------------------------------------------
		// ç”¨æˆ·æ³¨å†Œï¼šPOST /api/v1/signup
		api.POST("/signup", controller.SignUpHandler)
		// ç”¨æˆ·ç™»å½•ï¼šPOST /api/v1/login
		api.POST("/login", controller.LoginHandler)

		// ---------------------------------------------------
		// ğŸ”’ ç§æœ‰è·¯ç”± (å¿…é¡»å¸¦ Token æ‰èƒ½è®¿é—®)
		// ---------------------------------------------------
		// âš¡ï¸ æ ¸å¿ƒæŠ€å·§ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è·¯ç”±ç»„ auth
		// è™½ç„¶ auth çš„è·¯å¾„å‰ç¼€å’Œ api ä¸€æ · (éƒ½æ˜¯ /api/v1)ï¼Œ
		// ä½†æˆ‘ä»¬åªç»™ auth è¿™ä¸ªç»„æŒ‚è½½äº† JWT ä¸­é—´ä»¶ï¼
		auth := api.Group("")
		auth.Use(middleware.JWTAuthMiddleware()) // æŒ‚è½½é‰´æƒä¸­é—´ä»¶
		{
			// è·å–ä¸ªäººä¿¡æ¯ (æµ‹è¯• JWT ç”¨)
			// è®¿é—®è·¯å¾„ï¼šGET /api/v1/home
			// åªæœ‰ Token éªŒè¯é€šè¿‡ï¼Œæ‰ä¼šè¿›å…¥ controller.GetProfileHandler
			auth.GET("/home", controller.GetProfileHandler)

			// æœªæ¥å…¶ä»–çš„ç§æœ‰æ¥å£å†™åœ¨è¿™é‡Œ...
			// auth.POST("/article/publish", controller.CreateArticleHandler)
		}
	}

	// =======================================================
	// 5. å¤„ç† 404 (Not Found)
	// =======================================================
	r.NoRoute(func(c *gin.Context) {
		c.JSON(http.StatusNotFound, gin.H{
			"code": 404,
			"msg":  "404 Not Found (ä½ è®¿é—®çš„è·¯å¾„ä¸å­˜åœ¨)",
		})
	})

	return r
}
